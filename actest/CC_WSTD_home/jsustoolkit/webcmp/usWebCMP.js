(function(){function y(d){d=window.crosscert||{};var n=d.usWebCMPXMLHttp=d.usWebCMPXMLHttp||{},b=d.usWebCMP=d.usWebCMP||{},g=d.cmp=d.cmp||{},e=d.util||{},w=d.asn1||{},t=null,h=null,A=null,B=null,u=null,C=null,z=null;b.info={version:"0a",pkiReq:"00",pkiRep:"05",flags:"00",CMPURL:"https://10.10.10.74:8443"};b.revReason=g.revReason;b.issueCert=function(a,f,c,d,e,l,q,m,p,r){try{if(null==l||"undefined"==typeof l)throw{code:"120004",message:"StorageHendler is empty."};t=l;if(null==q||"undefined"==typeof q)throw{code:"120005",message:"The CMP callback function is empty."};h=q;null!=m&&"undefined"!=typeof m&&(A=m);null!=p&&"undefined"!=typeof p&&(B=p);null!=r&&"undefined"!=typeof r&&(u=r);b.info.storageInfo=d;var k=g.createGenmMessage(a,f,c,e),D=_create(k.toAsn1());n.uniSignE2ERequest("POST",D,b.info.CMPURL+"/GenmGenp.do",_issueCertGenPIR)}catch(x){h(3,"",x)}};_issueCertGenPIR=function(a){if("object"==typeof a)_showErrMSG(a);else try{var f=_parse(a);g.messageFromAsn1(f);try{var c=d.cmp.createIRMessage(A,B),e=_create(c.toAsn1());n.uniSignE2ERequest("POST",e,b.info.CMPURL+"/IrIp.do",_issueCertIPConf)}catch(k){h(3,"",k)}}catch(k){null!=k.code?_errMsg(k.message):h(3,"",k)}};_issueCertIPConf=function(a){if("object"==typeof a)_showErrMSG(a);else try{var f=_parse(a);g.messageFromAsn1(f);try{null==u||"undefined"==typeof u?_saveCertificate():u(t,g.user,_getCAName(d.pki.certificateFromBase64(g.user.signcert)),function(a){0==a?(a=d.cmp.createConfirmMessage(),a=_create(a.toAsn1()),n.uniSignE2ERequest("POST",a,b.info.CMPURL+"/Confirm.do",_CMPConfirm)):(a=d.cmp.createErrorMessage(),a=_create(a.toAsn1()),n.uniSignE2ERequest("POST",a,b.info.CMPURL+"/Confirm.do"))})}catch(c){h(3,"",c)}}catch(c){null!=c.code?_errMsg(c.message):h(3,"",c)}};_CMPConfirm=function(a){if("object"==typeof a)_showErrMSG(a);else try{var b=_parse(a);endtime=(new Date).getTime();"00"==e.bytesToHex(b)?h(1,""):h(2,"CMP fail!")}catch(c){null!=c.code?_errMsg(c.message):h(3,"",c)}};_errMsg=function(a){a="EncodingType=utf8&ErrMessage="+encodeURIComponent(b.messageToBase64(d.util.createBuffer(a)));n.uniSignE2ERequest("POST",a,b.info.CMPURL+"/EncodingErrMsg.do",_showErrMSG,"application/x-www-form-urlencoded;charset=UTF-8")};_showErrMSG=function(a){"object"==typeof a?h(2,(""!=a.statusText?a.statusText:a.responseText)+"(status :"+a.status+")"):h(2,b.messageFromBase64(a).toString())};_create=function(a){var f=e.createBuffer();a=w.toDer(a).getBytes();f.putBuffer(y(a.length+3));f.putBytes(e.hexToBytes(b.info.version));f.putBytes(e.hexToBytes(b.info.flags));f.putBytes(e.hexToBytes(b.info.pkiReq));f.putBytes(a);return b.messageToBase64(f)};_parse=function(a){a=b.messageFromBase64(decodeURIComponent(a));var f=a.getInt32();if(f!=a.length())throw{code:"120001",message:"WebCMP Message has wrong length."};if(a.getBytes(1)!=e.hexToBytes(b.info.version))throw{code:"120002",message:"WebCMP version is not supported."};a.getBytes(1);if(a.getBytes(1)!=e.hexToBytes(b.info.pkiRep))throw{code:"120003",message:"WebCMP message type is not supported."};return a.getBytes(f-3)};_saveCertificate=function(){try{var a=g.user;b.info.storageInfo?t.SaveUserCert(_getCAName(d.pki.certificateFromBase64(g.user.signcert)),a,b.info.storageInfo,!0):t.SaveUserCert(_getCAName(d.pki.certificateFromBase64(g.user.signcert)),a,!0)}catch(f){throw f;}return!0};_getCertName=function(a){return(new d.x509Certificate.certUtil).getDN(a.subject)};_getCAName=function(a){a=a.subject;for(var b=0;b<a.attributes.length;b++)if("o"==a.attributes[a.attributes.length-(b+1)].shortName)return d.util.createBuffer(a.attributes[a.attributes.length-(b+1)].value).toString().toLowerCase()};_deleteCertificate=function(){var a=_getCertName(g.info.signCert);return b.info.storageInfo?t.DeleteUserCertByDN(_getCAName(g.info.signCert),a,b.info.storageInfo):t.DeleteUserCertByDN(_getCAName(g.info.signCert),a)};b.revocation=function(a,f,c,e,k,l,q,m,p,r){try{if(null==q||"undefined"==typeof q)throw{code:"120006",message:"StorageHendler is empty."};t=q;if(null==m||"undefined"==typeof m)throw{code:"120007",message:"The CMP callback function is empty."};h=m;null!=p&&"undefined"!=typeof p&&(z=p);null!=r&&"undefined"!=typeof r&&(C=r);b.info.storageInfo=k;a=d.pki.certificateFromBase64(a);if(null==p||"undefined"==typeof p)f=d.pkcs8.encryptedPrivateKeyFromBase64(f);c=null!=g.info.kmCert&&"undefined"!=typeof g.info.kmCert?d.pki.certificateFromBase64(c):null;var v=g.createRRMessage(a,f,c,e,l,z),u=_create(v.toAsn1());n.uniSignE2ERequest("POST",u,b.info.CMPURL+"/Rr.do",_revocation1)}catch(x){h(3,"",x)}};_revocation1=function(a){if("object"==typeof a)_showErrMSG(a);else try{var b=_parse(a);g.messageFromAsn1(b);try{null==C||"undefined"==typeof C?_deleteCertificate():C(t,g.info.signCert),h(1)}catch(c){h(3,"",c)}}catch(c){null!=c.code?_errMsg(c.message):h(3,"",c)}};b.update=function(a,f,c,e,k,l,q,m,p,r,v,w,x){try{if(null==m||"undefined"==typeof m)throw{code:"120008",message:"StorageHendler is empty."};t=m;if(null==p||"undefined"==typeof p)throw{code:"120009",message:"The CMP callback function is empty."};h=p;null!=r&&"undefined"!=typeof r&&(A=r);null!=v&&"undefined"!=typeof v&&(B=v);null!=w&&"undefined"!=typeof w&&(z=w);null!=x&&"undefined"!=typeof x&&(u=x);b.info.storageInfo=l;l={};l.signCert=d.pki.certificateFromBase64(a);if(null==v||"undefined"==typeof v)l.signKey=d.pkcs8.encryptedPrivateKeyFromBase64(f);l.pw=k;"undefined"!==typeof c&&(l.kmCert=d.pki.certificateFromBase64(c),null==v||"undefined"==typeof v)&&(l.kmKey=d.pkcs8.encryptedPrivateKeyFromBase64(e));var D=g.createGenmMessage(l.signCert.serialNumber,"",k,q,l),y=_create(D.toAsn1());n.uniSignE2ERequest("POST",y,b.info.CMPURL+"/GenmGenp.do",_updateCertGenPKUR)}catch(F){h(3,"",F)}};_updateCertGenPKUR=function(a){if("object"==typeof a)_showErrMSG(a);else try{var f=_parse(a);g.messageFromAsn1(f);var c=d.cmp.createKURMessage(A,B,z),e=_create(c.toAsn1());n.uniSignE2ERequest("POST",e,b.info.CMPURL+"/KurKup.do",_updateCertKUPConf)}catch(k){null!=k.code?_errMsg(k.message):h(3,"",k)}};_updateCertKUPConf=function(a){if("object"==typeof a)_showErrMSG(a);else try{var f=_parse(a);g.messageFromAsn1(f);try{var c;if(null==u||"undefined"==typeof u)if(c=_saveCertificate()){var e=d.cmp.createConfirmMessage(z),k=_create(e.toAsn1());n.uniSignE2ERequest("POST",k,b.info.CMPURL+"/Confirm.do",_CMPConfirm)}else{var l=d.cmp.createErrorMessage(),q=_create(l.toAsn1());n.uniSignE2ERequest("POST",q,b.info.CMPURL+"/Confirm.do")}else u(t,g.user,_getCAName(d.pki.certificateFromBase64(g.user.signcert)),function(a){0==a?(a=d.cmp.createConfirmMessage(z),a=_create(a.toAsn1()),n.uniSignE2ERequest("POST",a,b.info.CMPURL+"/Confirm.do",_CMPConfirm)):(a=d.cmp.createErrorMessage(),a=_create(a.toAsn1()),n.uniSignE2ERequest("POST",a,b.info.CMPURL+"/Confirm.do"))})}catch(m){h(3,"",m)}}catch(m){null!=m.code?_errMsg(m.message):h(3,"",m)}};_updateCertConf=function(a){if("object"==typeof a)_showErrMSG(a);else try{var b=_parse(a);endtime=(new Date).getTime();"00"==e.bytesToHex(b)?h(1,""):h(2,"update fail!")}catch(c){null!=c.code?_errMsg(c.message):h(3,"",c)}};b.messageFromBase64=function(a){return e.createBuffer(e.decode64(a))};b.messageToBase64=function(a){"string"==typeof a&&(a=e.createBuffer(e.trim(a)));return e.encode64(a.getBytes())};var y=function(a){var b="";do b+=String.fromCharCode(a&255),a>>>=8;while(0<a);a=e.createBuffer();for(var c=0;c<4-b.length;c++)a.putByte(0);for(c=b.length-1;0<=c;c--)a.putByte(b.charCodeAt(c));return a}}var E=["./cmpasn1","./cmp","./usWebCMPXMLHttp"],w=null;"function"!==typeof define&&("object"===typeof module&&module.exports?w=function(d,n){n(require,module)}:(crosscert=window.crosscert=window.crosscert||{},y(crosscert)));(w||"function"===typeof define)&&(w||define)(["require","module"].concat(E),function(d,n){n.exports=function(b){var g=E.map(function(b){return d(b)}).concat(y);b=b||{};b.defined=b.defined||{};if(b.defined.asn1)return b.asn1;b.defined.asn1=!0;for(var e=0;e<g.length;++e)g[e](b);return b.asn1}})})();