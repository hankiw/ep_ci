(function(){function r(g){var h=g.jsustoolkitErrCode=g.jsustoolkitErrCode||{},a=g.asn1,b=g.cmp=g.cmp||{},k=g.oids=g.oids||{},n=g.util=g.util||{};b.info={version:0,id:[],certReqId:[0,1],referenceValue:[],secretValue:[],signature_algorithm:[],key_size:[],km_key_gen:[],km_key_backup:[],passwd_len:[],passwd_num_len:[],allow_suspend:[],dir_server_addr:[]};b.revReason={unspecified:0,keyCompromise:1,caCompromise:2,affiliationChanged:3,superseded:4,cessationOfOperation:5,certificateHold:6,unused:7,removeFromCRL:8,privilegeWithdrawn:9,aACompromise:10};b.user={};b.ca={};b.messageFromBase64=function(c){if(null==c||"undefined"==typeof c)throw{code:"114001",message:h["114001"]};c=a.fromDer(n.createBuffer(n.decode64(c)));return b.messageFromAsn1(c)};b.messageToBase64=function(b){if(null==b||"undefined"==typeof b)throw{code:"114002",message:h["114002"]};b=a.toDer(b.toAsn1());return n.encode64(b.getBytes())};b.messageFromAsn1=function(c){if(null==c||"undefined"==typeof c)throw{code:"114003",message:h["114003"]};"string"==typeof c&&(c=a.fromDer(n.createBuffer(c)));var d={},e=[];if(!a.validate(c,b.asn1.PKIMessage,d,e))throw{code:"114004",message:h["114004"],errors:e};c=d.body.type;switch(c){case b.asn1.PKIBodyType.genp:_freeTextSplit(d.header.value[3].value[0].value[0].value);b.info.caSignCert=d.body.value[0].value[0].value[1];d.body.value[0].value[1]&&(b.info.caEncCert=d.body.value[0].value[1].value[1]);break;case b.asn1.PKIBodyType.ip:_parseIPMessage(d);break;case b.asn1.PKIBodyType.kup:_parseKUPMessage(d);break;case b.asn1.PKIBodyType.conf:null==d.body.value[0]&&(b.info.certstate=!0);break;case b.asn1.PKIBodyType.rp:_parseRPMessage(d);break;case b.asn1.PKIBodyType.error:b.info.certstate=!1;_parseErrMessage(d);break;default:throw{code:"114005",message:h["114005"]+"("+c+")"};}};b.createGenmMessage=function(c,d,e,f,l){if(null==c||"undefined"==typeof c)throw{code:"114006",message:h["114006"]};if(null==d||"undefined"==typeof d)throw{code:"114007",message:h["114007"]};if(null==e||"undefined"==typeof e)throw{code:"114008",message:h["114008"]};if("undefined"==typeof f||""==f||null==l)f="";"undefined"==typeof l||""==l||null==l?(b.info.sender="",b.info.signpair={},b.info.kmpair={},b.info.secret="",b.info.newsignpair=null,b.info.newkmpair=null):(b.info.signCert=l.signCert,b.info.signpair={},b.info.signpair.publicKey=l.signCert.publicKey,"undefined"!=typeof l.signKey&&""!=l.signKey&&null!=l.signKey&&(b.info.signpair.privateKey=g.pki.privateKeyFromAsn1(g.pkcs8.decryptPrivateKeyInfo(l.signKey,l.pw))),b.info.sender=l.signCert.subject,"undefined"!=typeof l.kmCert&&(b.info.kmCert=l.kmCert,b.info.kmpair={},b.info.kmpair.publicKey=l.kmCert.publicKey,"undefined"!=typeof l.signKey&&""!=l.signKey&&null!=l.signKey&&(b.info.kmpair.privateKey=g.pki.privateKeyFromAsn1(g.pkcs8.decryptPrivateKeyInfo(l.kmKey,l.pw)))));l=null;b.info.referenceValue=c;b.info.secretValue=d;b.info.text=e;b.info.mediaType=f;return l={type:b.asn1.PKIBodyType.genm,version:0,toAsn1:function(){var c=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]),d=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,String.fromCharCode(b.info.version))]);""==b.info.sender?d.value.push(a.create(a.Class.CONTEXT_SPECIFIC,1,!1,String.fromCharCode(32))):d.value.push(a.create(a.Class.CONTEXT_SPECIFIC,4,!0,[g.pki.distinguishedNameToAsn1({attributes:b.info.sender.attributes})]));d.value.push(a.create(a.Class.CONTEXT_SPECIFIC,1,!1,String.fromCharCode(32)));d.value.push(a.create(a.Class.CONTEXT_SPECIFIC,2,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,b.info.referenceValue)]));if(""!=b.info.mediaType){var e=a.create(a.Class.CONTEXT_SPECIFIC,7,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.UTF8,!1,mediaType)])]);d.value.push(e)}e=a.create(a.Class.CONTEXT_SPECIFIC,21,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(k.caProtEncCert).getBytes())])])]);c.value.push(d);c.value.push(e);return c}}};b.createIRMessage=function(c,d){var e=null;b.info.snonce=g.random.getBytes(16);null==c||"undefined"==typeof c?b.info.signpair=g.pki.rsa.generateKeyPair(b.info.key_size):(b.info.signpair={},b.info.signpair.publicKey=c(b.info.key_size));0!=b.info.km_key_gen.length&&"user"==b.info.km_key_gen&&(b.info.kmpair=g.pki.rsa.generateKeyPair(b.info.key_size));return e={type:b.asn1.PKIBodyType.ir,version:0,toAsn1:function(){var c=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]),e=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,String.fromCharCode(b.info.version)),a.create(a.Class.CONTEXT_SPECIFIC,1,!1,String.fromCharCode(32)),a.create(a.Class.CONTEXT_SPECIFIC,1,!1,String.fromCharCode(32)),a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.GENERALIZEDTIME,!1,a.dateToGeneralizedTime(new Date))]),a.create(a.Class.CONTEXT_SPECIFIC,2,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,b.info.referenceValue)]),a.create(a.Class.CONTEXT_SPECIFIC,5,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,b.info.snonce)])]);var g=b.info.caEncCert?a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[_CertRequest("Sign"),_proofOfPossession(1,"Sign","new",d),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[_attributeTypeAndValue("encryptedVID",_encryptedVID())])])]):a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[_CertRequest("Sign"),_proofOfPossession(1,"Sign","new",d)])]);if(0!=b.info.km_key_gen.length&&"user"==b.info.km_key_gen){var h=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[_CertRequest("KM"),_proofOfPossession(1,"KM","new")]);g.value.push(h)}h=a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[]);h.value.push(g);c.value.push(e);c.value.push(h);e=a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,String.fromCharCode(0)+_processProtection("MAC",a.toDer(c).getBytes()))]);c.value.push(e);return c}}};b.createConfirmMessage=function(c){var d=null;return d={type:b.asn1.PKIBodyType.conf,version:0,toAsn1:function(){var d=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]),f=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,String.fromCharCode(b.info.version)),a.create(a.Class.CONTEXT_SPECIFIC,1,!1,String.fromCharCode(32)),a.create(a.Class.CONTEXT_SPECIFIC,1,!1,String.fromCharCode(32)),a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.GENERALIZEDTIME,!1,a.dateToGeneralizedTime(new Date))])]);"undefined"!=typeof b.info.newsignpair&&null!=b.info.newsignpair||f.value.push(a.create(a.Class.CONTEXT_SPECIFIC,2,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,b.info.referenceValue)]));f.value.push(a.create(a.Class.CONTEXT_SPECIFIC,5,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,b.info.snonce)]));f.value.push(a.create(a.Class.CONTEXT_SPECIFIC,6,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,b.info.rnonce)]));var g=a.create(a.Class.UNIVERSAL,a.Type.NULL,!1,""),h=a.create(a.Class.CONTEXT_SPECIFIC,19,!0,[]);h.value.push(g);d.value.push(f);d.value.push(h);f=a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[]);"undefined"==typeof b.info.newsignpair||null==b.info.newsignpair?f.value.push(a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,String.fromCharCode(0)+_processProtection("MAC",a.toDer(d).getBytes()))):f.value.push(a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,String.fromCharCode(0)+_processProtection("Sign",d,c)));d.value.push(f);b.info.signpair.privateKey="";null!=b.info.kmCert&&"undefined"!=typeof b.info.kmCert&&(b.info.kmpair.privateKey="");return d}}};b.createRRMessage=function(c,d,e,f,l,m){if(null==c||"undefined"==typeof c)throw{code:"114010",message:h["114010"]};if(null==d||"undefined"==typeof d)throw{code:"114011",message:h["114011"]};if(null==f||"undefined"==typeof f)throw{code:"114012",message:h["114012"]};if(null==l||"undefined"==typeof l)throw{code:"114013",message:h["114013"]};var q=null;b.info.signCert=c;b.info.kmCert=e;b.info.revokeNum=l;b.info.signpair={};if(null==m||"undefined"==typeof m)b.info.signpair.privateKey=g.pki.privateKeyFromAsn1(g.pkcs8.decryptPrivateKeyInfo(d,f));b.info.signature_algorithm=g.pki.oids[c.siginfo.algorithmOid];var k=g.random.getBytes(16);return q={type:b.asn1.PKIBodyType.rr,version:0,toAsn1:function(){var c=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]),d=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,String.fromCharCode(b.info.version)),a.create(a.Class.CONTEXT_SPECIFIC,4,!0,[g.pki.distinguishedNameToAsn1({attributes:b.info.signCert.subject.attributes})]),a.create(a.Class.CONTEXT_SPECIFIC,1,!1,String.fromCharCode(32)),a.create(a.Class.CONTEXT_SPECIFIC,5,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,k)])]),e=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]);e.value.push(_RevDetails(b.info.signCert.serialNumber,b.info.revokeNum));null!=b.info.kmCert&&"undefined"!=typeof b.info.kmCert&&e.value.push(_RevDetails(b.info.kmCert.serialNumber,b.info.revokeNum));var f=a.create(a.Class.CONTEXT_SPECIFIC,11,!0,[]);f.value.push(e);c.value.push(d);c.value.push(f);d=a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,String.fromCharCode(0)+_processProtection("Sign",c,m))]);c.value.push(d);return c}}};b.createKURMessage=function(c,d,e){var f=null;b.info.snonce=g.random.getBytes(16);null==c||"undefined"==typeof c?b.info.newsignpair=g.pki.rsa.generateKeyPair(b.info.key_size):(b.info.newsignpair={},b.info.newsignpair.publicKey=c(b.info.key_size));0!=b.info.km_key_gen.length&&"user"==b.info.km_key_gen&&(b.info.newkmpair=g.pki.rsa.generateKeyPair(b.info.key_size));return f={type:b.asn1.PKIBodyType.kur,version:0,toAsn1:function(){var c=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]),h=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,String.fromCharCode(b.info.version)),a.create(a.Class.CONTEXT_SPECIFIC,4,!0,[g.pki.distinguishedNameToAsn1({attributes:b.info.signCert.subject.attributes})]),a.create(a.Class.CONTEXT_SPECIFIC,1,!1,String.fromCharCode(32)),a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.GENERALIZEDTIME,!1,a.dateToGeneralizedTime(new Date))]),a.create(a.Class.CONTEXT_SPECIFIC,5,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,b.info.snonce)])]);var q=b.info.caEncCert?a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[_CertRequest("Sign",f.type),_proofOfPossession(1,"Sign","keyupdate",d),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[_attributeTypeAndValue("encryptedVID",_encryptedVID())])])]):a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[_CertRequest("Sign",f.type),_proofOfPossession(1,"Sign","keyupdate",d)])]);if(0!=b.info.km_key_gen.length&&"user"==b.info.km_key_gen){var k=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[_CertRequest("KM"),_proofOfPossession(1,"KM","keyupdate")]);q.value.push(k)}k=a.create(a.Class.CONTEXT_SPECIFIC,f.type,!0,[]);k.value.push(q);c.value.push(h);c.value.push(k);h=a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,String.fromCharCode(0)+_processProtection("Sign",c,e))]);c.value.push(h);return c}}};_RevDetails=function(b,d){return a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.CONTEXT_SPECIFIC,1,!1,g.util.hexToBytes(b))]),a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,_genRevokeNum(d))])};_genRevokeNum=function(a){switch(a){case 0:a="80";var b=7;break;case 1:a="40";b=6;break;case 2:a="20";b=5;break;case 3:a="10";b=4;break;case 4:a="08";b=3;break;case 5:a="04";b=2;break;case 6:a="02";b=1;break;case 7:a="01";b=0;break;case 8:a="8000";b=15;break;default:throw{code:"114014",message:h["114014"]+"("+a+")"};}return String.fromCharCode(b)+g.util.hexToBytes(a)};_parseIPMessage=function(c){if(null==c||"undefined"==typeof c)throw{code:"114015",message:h["114015"]};var d={},e=[];if(!a.validate(c.header,b.asn1.PKIHeader,d,e))throw{code:"114051",message:h["114051"],errors:e};var f=a.derToOid(d.protectionAlg.value[0].value[0].value);if(b.info.snonce!=d.recipNonce.value[0].value)throw{code:"114052",message:h["114052"],errors:e};b.info.rnonce=d.senderNonce.value[0].value;d=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]);d.value.push(c.header);d.value.push(c.body);if("passwordBasedMac"==k[f])f=_processProtection("MAC",a.toDer(d).getBytes());else throw{code:"114016",message:h["114016"]+"("+f+")"};if(f==c.protection.value[0].value.substring(1))_processCertRepMessage(c,b.asn1.PKIBodyType.ip);else throw{code:"114027",message:h["114027"]};};_parseRPMessage=function(c){var d={},e=[];if(!a.validate(c.body.value[0],b.asn1.RevRepContent,d,e))throw{code:"114028",message:h["114028"],errors:e};for(c=0;c<d.status.value.length;c++){var f={};if(!a.validate(d.status.value[c],b.asn1.PKIStatusInfo,f,e))throw{code:"114029",message:h["114029"],errors:e};if(0!=f.status&&(f=_parsePKIFreeText(f.statusString),"granted"!=f[0]))throw{code:"114030",message:h["114030"]+f[0],errors:e};}};_processCertRepMessage=function(c,d){var e={},f={},l={},m=[];if(!a.validate(c.body.value[0],b.asn1.CertRepMessage,e,m))throw{code:"114017",message:h["114017"],errors:m};null!=e.caPubs&&_getCAPubs(e.caPubs);for(c=0;c<e.response.value.length;c++){if(!a.validate(e.response.value[c],b.asn1.CertResponse,f,m))throw{code:"114018",message:h["114018"],errors:m};if(b.info.certReqId[c]==f.certReqId.charCodeAt()){if(!a.validate(f.status,b.asn1.PKIStatusInfo,l,m))throw{code:"114019",message:h["114019"],errors:m};if(0==l.status.charCodeAt()){var k={};if(!a.validate(f.certifiedKeyPair,b.asn1.CertifiedKeyPair,k,m))throw{code:"114020",message:h["114020"],errors:m};if(null!=k.certificate)if(b.user.signcert=g.pki.certificateToBase64(g.pki.certificateFromAsn1(k.certificate[0])),null==b.info.signpair.privateKey||"undefined"==typeof b.info.signpair.privateKey)b.user.vidr=b.info.r;else if(b.asn1.PKIBodyType.ip==d)b.user.signpri=g.pkcs8.encryptRsaPrivateKey(b.info.signpair.privateKey,b.info.r,b.info.text,{algorithm:"seed"},"base64");else if(b.asn1.PKIBodyType.kup==d)b.user.signpri=g.pkcs8.encryptRsaPrivateKey(b.info.newsignpair.privateKey,b.info.r,b.info.text,{algorithm:"seed"},"base64"),console.debug("signCertUpdate : "+b.user.signcert),console.debug("signpriUpdate : "+b.user.signpri);else throw{code:"114049",message:h["114049"],errors:m};else if(null!=k.EncryptedCert){var n={};if(!a.validate(k.EncryptedCert.value[0],b.asn1.EncryptedValue,n,m))throw{code:"114021",message:h["114021"],errors:m};k=n.encSymmKey.substring(1);n=n.encValue.substring(1);if(b.asn1.PKIBodyType.ip==d)var p=b.info.kmpair.privateKey;else if(b.asn1.PKIBodyType.kup==d)p=b.info.newkmpair.privateKey;else throw{code:"114050",message:h["114050"],errors:m};k=p.decrypt(k);b.info.secret=k;k=g.cipher.algorithms.desofb.startEncrypting(k,"01234567");k.update(g.util.createBuffer(n));k.finish();b.user.kmcert=g.pki.certificateToBase64(g.pki.certificateFromAsn1(a.fromDer(g.util.createBuffer(k.output.data))));if(b.asn1.PKIBodyType.ip==d)b.user.kmpri=g.pkcs8.encryptRsaPrivateKey(b.info.kmpair.privateKey,b.info.r,b.info.text,{algorithm:"seed"},"base64");else if(b.asn1.PKIBodyType.kup==d)b.user.kmpri=g.pkcs8.encryptRsaPrivateKey(b.info.newkmpair.privateKey,b.info.r,b.info.text,{algorithm:"seed"},"base64");else throw{code:"114050",message:h["114050"],errors:m};}else throw{code:"114022",message:h["114022"],errors:m};}else{if(2==l.status.charCodeAt()){if(null!=l.statusString){d=_parsePKIFreeText(l.statusString);if(null!=l.failInfo)throw{code:"114023",message:h["114023"]+d[0]+"(PKIFailureInfo : "+l.failInfo.charCodeAt()+")",errors:m};throw{code:"114024",message:h["114024"]+d[0],errors:m};}throw{code:"114025",message:h["114025"]+l.failInfo.charCodeAt(),errors:m};}throw{code:"114026",message:h["114026"]+"(CertResponse status:"+f.status.value[0].value.charCodeAt()+")",errors:m};}}}b.info.r="";b.info.text=""};_parseKUPMessage=function(c){if(null==c||"undefined"==typeof c)throw{code:"114045",message:h["114045"]};var d={},e=[];if(!a.validate(c.header,b.asn1.PKIHeader,d,e))throw{code:"114053",message:h["114053"],errors:e};var f=a.derToOid(d.protectionAlg.value[0].value[0].value);if(b.info.snonce!=d.recipNonce.value[0].value)throw{code:"114054",message:h["114054"],errors:e};b.info.rnonce=d.senderNonce.value[0].value;d=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]);d.value.push(c.header);d.value.push(c.body);if("sha256WithRSAEncryption"==k[f])f=_processProtectionVerify(a.toDer(d).getBytes(),c.protection.value[0].value.substring(1));else throw{code:"114046",message:h["114046"]+"("+f+")"};if(1==f)_processCertRepMessage(c,b.asn1.PKIBodyType.kup);else throw{code:"114047",message:h["114047"]};};_parseErrMessage=function(c){var d={},e={},f=[];if(!a.validate(c.body.value[0],b.asn1.ErrorMsgContent,d,f))throw{code:"114031",message:h["114031"],errors:f};if(!a.validate(d.status,b.asn1.PKIStatusInfo,e,f))throw{code:"114032",message:h["114032"],errors:f};c=_parsePKIFreeText(e.statusString);throw{code:"114033",message:h["114033"]+c[0],errors:f};};_parsePKIFreeText=function(a){if(null==a||"undefined"==typeof a)throw{code:"114034",message:h["114034"]};for(var b=[],c,f=0;f<a.value.length;++f)c=a.value[f],b.push(c.value);return b};_CertRequest=function(c,d){if(null==c||"undefined"==typeof c)throw{code:"114035",message:h["114035"]};var e=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,String.fromCharCode("Sign"==c?b.info.certReqId[0]:b.info.certReqId[1])),_CertTemplate(c)]);b.asn1.PKIBodyType.kur==d&&"Sign"==c&&(c=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(k.oldCertID).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.CONTEXT_SPECIFIC,4,!0,[g.pki.distinguishedNameToAsn1({attributes:b.info.signCert.issuer.attributes})]),a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,g.util.hexToBytes(b.info.signCert.serialNumber))])])]),e.value.push(c));return e};_CertTemplate=function(b){var c=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]);c.value.push(_setCertTemplate(6,b));return c};_setCertTemplate=function(a,d){d="Sign"==d?"undefined"!=typeof b.info.newsignpair&&null!=b.info.newsignpair&&null!=b.info.newsignpair.publicKey&&""!=b.info.newsignpair.publicKey?g.pki.publicKeyToAsn1(b.info.newsignpair.publicKey):g.pki.publicKeyToAsn1(b.info.signpair.publicKey):"undefined"!=typeof b.info.newkmpair&&null!=b.info.newkmpair&&null!=b.info.newkmpair.publicKey&&""!=b.info.newkmpair.publicKey?g.pki.publicKeyToAsn1(b.info.newkmpair.publicKey):g.pki.publicKeyToAsn1(b.info.kmpair.publicKey);switch(a){case 6:if(-1<b.info.signature_algorithm.indexOf("RSA"))return _change(d);throw{code:"114036",message:h["114036"],errors:errors};}};_change=function(b){if(null==b||"undefined"==typeof b)throw{code:"114037",message:h["114037"]};var c=a.create(a.Class.CONTEXT_SPECIFIC,6,!0,[]);c.value.push(a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[b.value[0].value[0]]));c.value.push(b.value[1]);return c};_freeTextSplit=function(a){a=a.split("$");for(var c=0;c<a.length;c++)if(""!=a[c]){var e=a[c].split("=");if("signature_algorithm"==e[0])b.info.signature_algorithm=e[1];else if("key_size"==e[0])b.info.key_size=e[1];else if("km_key_gen"==e[0])b.info.km_key_gen=e[1];else if("km_key_backup"==e[0])b.info.km_key_backup=e[1];else if("passwd_len"==e[0])b.info.passwd_len=e[1];else if("passwd_num_len"==e[0])b.info.passwd_num_len=e[1];else if("allow_suspend"==e[0])b.info.allow_suspend=e[1];else if("dir_server_addr"==e[0])b.info.dir_server_addr=e[1];else throw{code:"114038",message:h["114038"]+"("+e[0]+":"+e[1]+")",errors:errors};}};_proofOfPossession=function(c,d,e,f){"undefined"==typeof e&&(e="new");var g=a.create(a.Class.CONTEXT_SPECIFIC,c,!0,[]);switch(c){case 0:throw{code:"114039",message:h["114039"]};case 1:c=_popoSigningKeyInput(0,d);g.value.push(a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[c.value[0],c.value[1]]));g.value.push(a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(k[b.info.signature_algorithm]).getBytes())]));g.value.push(a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,String.fromCharCode(0)+_signature(c,d,e,f)));break;case 2:throw{code:"114040",message:h["114040"]};case 3:throw{code:"114041",message:h["114041"]};default:throw{code:"114042",message:h["114042"]};}return g};_popoSigningKeyInput=function(c,d){var e=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]);switch(c){case 0:e.value.push(a.create(a.Class.CONTEXT_SPECIFIC,c,!0,[a.create(a.Class.CONTEXT_SPECIFIC,1,!1,String.fromCharCode(32))]));break;default:throw{code:"114043",message:h["114043"]};}publickeyValue="Sign"==d?"undefined"!=typeof b.info.newsignpair&&null!=b.info.newsignpair&&null!=b.info.newsignpair.publicKey&&""!=b.info.newsignpair.publicKey?g.pki.publicKeyToAsn1(b.info.newsignpair.publicKey):g.pki.publicKeyToAsn1(b.info.signpair.publicKey):"undefined"!=typeof b.info.newkmpair&&null!=b.info.newkmpair&&null!=b.info.newkmpair.publicKey&&""!=b.info.newkmpair.publicKey?g.pki.publicKeyToAsn1(b.info.newkmpair.publicKey):g.pki.publicKeyToAsn1(b.info.kmpair.publicKey);c=_change(publickeyValue);e.value.push(a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[c.value[0],c.value[1]]));return e};_signature=function(c,d,e,f){var h=b.info.signature_algorithm.split("With");if("Sign"==d)if("keyupdate"==e){if(null==f||"undefined"==typeof f)var k=b.info.newsignpair.privateKey}else{if(null==f||"undefined"==typeof f)k=b.info.signpair.privateKey}else k="keyupdate"==e?b.info.newkmpair.privateKey:b.info.kmpair.privateKey;d=g.md.algorithms[h[0]].create();d.start();d.update(a.toDer(c).getBytes());return null==f||"undefined"==typeof f?k.sign(d):f(d)};_attributeTypeAndValue=function(b,d){var c=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]);c.value.push(a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(k[b]).getBytes()));null!=d&&c.value.push(d);return c};_encryptedVID=function(){var c=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]);c.value.push(a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,String.fromCharCode(0))]));c.value.push(a.create(a.Class.CONTEXT_SPECIFIC,2,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(k.RSAEncryption).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.NULL,!1,"")])]));c.value.push(a.create(a.Class.CONTEXT_SPECIFIC,3,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[b.info.caEncCert.value[0].value[3],b.info.caEncCert.value[0].value[1]])]));c.value.push(a.create(a.Class.CONTEXT_SPECIFIC,4,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,_encVID())]));return c};_encVID=function(){var c=b.info.signature_algorithm.split("With");b.info.r=g.random.getBytes(20);var d=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.PRINTABLESTRING,!1,"1234561234567"),a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,String.fromCharCode(0)+b.info.r)]),e=g.md.algorithms[c[0]].create();e.start();e.update(a.toDer(d).getBytes());d=e.digest();e.start();e.update(d.bytes());d=e.digest();c=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(k[c[0]]).getBytes())]),a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,d.bytes())])]),a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,String.fromCharCode(0)+b.info.r)]);return g.pki.certificateFromAsn1(b.info.caEncCert).publicKey.encrypt(a.toDer(c).getBytes())};_processProtection=function(a,b,e){if("Sign"==a)a=_processProtectionSign(b,e);else if("MAC"==a)a=_processProtectionMac(b);else throw{code:"114044",message:h["114044"],errors:errors};return a};_processProtectionVerify=function(a,d){var c=g.pki.certificateFromAsn1(b.info.caSignCert),f=k[c.signatureOid].split("With");f=g.md.algorithms[f[0]].create();f.start();f.update(a);return c.publicKey.verify(f.digest().getBytes(),d)};_processProtectionSign=function(a,b){return _signature(a,"Sign","new",b)};_processProtectionMac=function(a){if(""!=b.info.secret&&"undefined"!==typeof b.info.secret){var c="aaaaabbbbb"+g.util.bytesToHex(b.info.secret);b.info.secret=""}else c="aaaaabbbbb"+b.info.secretValue;for(var e=g.md.algorithms.sha1.create(),f=0;2>f;f++)e.start(),e.update(c),c=e.digest(),c=c.bytes();c=g.cipher.algorithms.des.startEncrypting(c.substring(0,8),g.util.hexToBytes("0000000000000000"));c.update(g.util.createBuffer(a));c.finish(_zero_padding);c=c.output.data;return c.substring(c.length-8,c.length)};_zero_padding=function(a,b,e){e||(a=b.length()==a?0:a-b.length(),b.fillWithByte(0,a));return!0};_getCAPubs=function(a){for(var c={certs:{}},e=0;e<a.value[0].value.length;e++){var f=g.x509Certificate.parser(a.value[0].value[e],"ASN1");""==g.x509Certificate.getAuthorityKeyIdentifier()?b.ca.RootCA=g.pki.certificateToPem(f):(c.certs[f.subject.hash]=g.pki.certificateToPem(f),e==a.value[0].value.length-1&&(b.ca.CA=c))}}}var t="./asn1 ./oids ./cmpasn1 ./pki ./util ./random ./jsustoolkitErrCode".split(" "),p=null;"function"!==typeof define&&("object"===typeof module&&module.exports?p=function(g,h){h(require,module)}:(crosscert=window.crosscert=window.crosscert||{},r(crosscert)));(p||"function"===typeof define)&&(p||define)(["require","module"].concat(t),function(g,h){h.exports=function(a){var b=t.map(function(a){return g(a)}).concat(r);a=a||{};a.defined=a.defined||{};if(a.defined.cmp)return a.cmp;a.defined.cmp=!0;for(var h=0;h<b.length;++h)b[h](a);return a.cmp}})})();