(function(){function r(g){var h=g.jsustoolkitErrCode=g.jsustoolkitErrCode||{},c=g.pkcs8=g.pkcs8||{},a=g.asn1,t=g.pkcs5=g.pkcs5||{},k=g.pki=g.pki||{},m=k.oids,p={name:"EncryptedPrivateKeyInfo",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"EncryptedPrivateKeyInfo.encryptionAlgorithm",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:a.Class.UNIVERSAL,type:a.Type.OID,constructed:!1,capture:"encryptionOid"},{name:"AlgorithmIdentifier.parameters",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,captureAsn1:"encryptionParams"}]},{name:"EncryptedPrivateKeyInfo.encryptedData",tagClass:a.Class.UNIVERSAL,type:a.Type.OCTETSTRING,constructed:!1,capture:"encryptedData"}]};c.privateKeyValidator={name:"PrivateKeyInfo",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"PrivateKeyInfo.version",tagClass:a.Class.UNIVERSAL,type:a.Type.INTEGER,constructed:!1,capture:"privateKeyVersion"},{name:"PrivateKeyInfo.privateKeyAlgorithm",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:a.Class.UNIVERSAL,type:a.Type.OID,constructed:!1,capture:"privateKeyOid"}]},{name:"PrivateKeyInfo",tagClass:a.Class.UNIVERSAL,type:a.Type.OCTETSTRING,constructed:!1,capture:"privateKey"},{name:"Random",tagClass:a.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,optional:!0,value:[{name:"Attributes",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"AttrOID",tagClass:a.Class.UNIVERSAL,type:a.Type.OID,constructed:!1,capture:"attributesOid"},{name:"AttributesValue",tagClass:a.Class.UNIVERSAL,type:a.Type.SET,constructed:!0,value:[{name:"rand",tagClass:a.Class.UNIVERSAL,type:a.Type.BITSTRING,constructed:!1,capture:"attributesRandom"}]}]}]}]};c.getPrivateKeyAttributesRandom=function(d){if(null==d||"undefined"==typeof d)throw{code:"111019",message:h["111019"]};var e={},b=[];if(!a.validate(d,g.pkcs8.privateKeyValidator,e,b))throw{code:"111020",message:h["111020"],errors:b};return"undefined"!=typeof e.attributesOid&&a.derToOid(e.attributesOid)==m.identifyData_random?(d=g.util.createBuffer(e.attributesRandom),++d.read,d.getBytes()):""};c.rsaPrivateKeyInfo=function(d,e){if(null==d||"undefined"==typeof d)throw{code:"111021",message:h["111021"]};var b=a.oidToDer(m.RSAEncryption).getBytes(),f=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]);f.value.push(a.create(a.Class.UNIVERSAL,a.Type.OID,!1,b));f.value.push(a.create(a.Class.UNIVERSAL,a.Type.NULL,!1,""));b=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,String.fromCharCode(0)),f,a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,a.toDer(d).getBytes())]);null!=e&&(f=a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(m.identifyData_random).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.SET,!0,[a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,String.fromCharCode(0)+e)])])]),b.value.push(f));return b};c.encryptPrivateKeyInfo=function(d,e,b){if(null==d||"undefined"==typeof d)throw{code:"111022",message:h["111022"]};if(null==e||"undefined"==typeof e)throw{code:"111023",message:h["111023"]};b=b||{};b.saltSize=b.saltSize||8;b.count=b.count||2048;b.algorithm=b.algorithm||"seed";b.salt=b.salt||g.random.getBytes(b.saltSize);var f=b.salt,c=b.count,q=g.util.createBuffer();q.putInt16(c);var n;if(0===b.algorithm.indexOf("aes")||0===b.algorithm.indexOf("seed")){var k;if("aes128"===b.algorithm)n=16,k=m["aes128-CBC"];else if("aes192"===b.algorithm)n=24,k=m["aes192-CBC"];else if("aes256"===b.algorithm)n=32,k=m["aes256-CBC"];else if("seed"===b.algorithm)n=16,k=m["seed-CBC"];else throw{code:"111024",message:h["111024"]+"("+b.algorithm+")"};n=g.pkcs5.pbkdf2(e,f,c,n);e=g.random.getBytes(16);b=g.cipher.algorithms[b.algorithm].createEncryptionCipher(n);b.start(e);b.update(a.toDer(d));b.finish();d=b.output.getBytes();f=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(m.pkcs5PBES2).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(m.pkcs5PBKDF2).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,f),a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,q.getBytes())])]),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(k).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,e)])])])}else if("3des"===b.algorithm)n=24,k=new g.util.ByteBuffer(f),n=g.pkcs12.generateKey(e,k,1,c,n),e=g.pkcs12.generateKey(e,k,2,c,8),b=g.des.createEncryptionCipher(n),b.start(e),b.update(a.toDer(d)),b.finish(),d=b.output.getBytes(),f=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(m["pbeWithSHAAnd3-KeyTripleDES-CBC"]).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,f),a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,q.getBytes())])]);else throw{code:"111025",message:h["111025"]+"("+b.algorithm+")"};return a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[f,a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,d)])};c.decryptPrivateKeyInfo=function(d,e){if(null==d||"undefined"==typeof d)throw{code:"111026",message:h["111026"]};if(null==e||"undefined"==typeof e)throw{code:"111027",message:h["111027"]};var b=null,c={},l=[];if(!a.validate(d,p,c,l))throw{code:"111028",message:h["111028"],errors:l};l=a.derToOid(c.encryptionOid);l=t.pbe.getCipher(l,c.encryptionParams,e);c=g.util.createBuffer(c.encryptedData);l.update(c);l.finish()&&(b=a.fromDer(l.output));return b};c.encryptedPrivateKeyToPem=function(d,c){if(null==d||"undefined"==typeof d)throw{code:"111029",message:h["111029"]};var b=a.toDer(d),b=g.util.encode64(b.getBytes(),c||64);return"-----BEGIN ENCRYPTED PRIVATE KEY-----\r\n"+b+"\r\n-----END ENCRYPTED PRIVATE KEY-----"};c.encryptedPrivateKeyToBase64=function(d){if(null==d||"undefined"==typeof d)throw{code:"111030",message:h["111030"]};d=a.toDer(d);return g.util.encode64(d.getBytes())};c.encryptedPrivateKeyFromPem=function(d){if(null==d||"undefined"==typeof d)throw{code:"111031",message:h["111031"]};d=k.pemToDer(d);return a.fromDer(d)};c.encryptedPrivateKeyFromBase64=function(d){if(null==d||"undefined"==typeof d)throw{code:"111032",message:h["111032"]};d=k.base64ToDer(d);return a.fromDer(d)};c.encryptRsaPrivateKey=function(a,e,b,f,g){g=g||"bin";a=c.rsaPrivateKeyInfo(k.privateKeyToAsn1(a),e);a=c.encryptPrivateKeyInfo(a,b,f);if("bin"==g)return a;if("base64"==g)return c.encryptedPrivateKeyToBase64(a);if("pem"==g)return c.encryptedPrivateKeyToPem(a);throw{code:"111040",message:h["111040"]+"(type:"+g+")"};};c.decryptRsaPrivateKeyFromPem=function(a,e){var b=c.decryptRsaPrivateKeyInfoFromPem(a,e);null!==b&&(b=k.privateKeyFromAsn1(b));return b};c.decryptRsaPrivateKeyInfoFromPem=function(a,e){var b=c.encryptedPrivateKeyFromPem(a);return c.decryptPrivateKeyInfo(b,e)};c.decryptRsaPrivateKeyFromBase64=function(a,e){var b=c.decryptRsaPrivateKeyInfoFromBase64(a,e);null!==b&&(b=k.privateKeyFromAsn1(b));return b};c.decryptRsaPrivateKeyInfoFromBase64=function(a,e){var b=c.encryptedPrivateKeyFromBase64(a);return c.decryptPrivateKeyInfo(b,e)};c.checkUserCertPassword=function(a,e){if(null==e||"undefined"==typeof e)throw{code:"111034",message:h["111034"]};if(null==a||"undefined"==typeof a)throw{code:"111035",message:h["111035"]};try{return a=c.decryptPrivateKeyInfo(a,e),null!==a?(k.privateKeyFromAsn1(a),!0):!1}catch(b){return!1}};c.changePassword=function(a,e,b,f){if(null==a||"undefined"==typeof a)throw{code:"111036",message:h["111036"]};if(null==e||"undefined"==typeof e)throw{code:"111037",message:h["111037"]};if(null==b||"undefined"==typeof b)throw{code:"111038",message:h["111038"]};f=f||"bin";a=c.decryptPrivateKeyInfo(a,e);a=c.encryptPrivateKeyInfo(a,b,{algorithm:"seed"});if("bin"==f)return a;if("Base64"==f)return c.encryptedPrivateKeyToBase64(a);if("PEM"==f)return c.encryptedPrivateKeyToPem(a);throw{code:"111039",message:h["111039"]+"("+f+")"};};c.verifyVIDForHSM=function(d,c,b){if(null==d||"undefined"==typeof d)throw{code:"111045",message:h["111045"]};if(null==c||"undefined"==typeof c)throw{code:"111043",message:h["111043"]};if(null==b||"undefined"==typeof b)throw{code:"111044",message:h["111044"]};for(var f=g.asn1.fromDer(b.getExtension("subjectAltName").value),l=0;l<f.value.length;l++)if(0==f.value[l].type&&m.identifyData==a.derToOid(f.value[l].value[0].value)){b=m[a.derToOid(f.value[l].value[1].value[0].value[1].value[0].value[1].value[0].value[0].value)];f=f.value[l].value[1].value[0].value[1].value[0].value[1].value[1].value[0].value;d=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.PRINTABLESTRING,!1,c),a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,String.fromCharCode(0)+d)]);c=g.md.algorithms[b].create();c.start();c.update(a.toDer(d).getBytes());d=c.digest();c.start();c.update(d.bytes());d=c.digest();if(f==d.bytes())return!0;break}return!1};c.verifyVID=function(d,e,b,f){if(null==d||"undefined"==typeof d)throw{code:"111041",message:h["111041"]};if(null==e||"undefined"==typeof e)throw{code:"111042",message:h["111042"]};if(null==b||"undefined"==typeof b)throw{code:"111043",message:h["111043"]};if(null==f||"undefined"==typeof f)throw{code:"111044",message:h["111044"]};for(var l=g.asn1.fromDer(f.getExtension("subjectAltName").value),k=0;k<l.value.length;k++)if(0==l.value[k].type&&m.identifyData==a.derToOid(l.value[k].value[0].value)){f=m[a.derToOid(l.value[k].value[1].value[0].value[1].value[0].value[1].value[0].value[0].value)];l=l.value[k].value[1].value[0].value[1].value[0].value[1].value[1].value[0].value;d=c.decryptPrivateKeyInfo(d,e);d=c.getPrivateKeyAttributesRandom(d);b=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.PRINTABLESTRING,!1,b),a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,String.fromCharCode(0)+d)]);f=g.md.algorithms[f].create();f.start();f.update(a.toDer(b).getBytes());b=f.digest();f.start();f.update(b.bytes());b=f.digest();if(l==b.bytes())return!0;break}return!1}}var s="./aes ./seed ./asn1 ./jsbn ./md ./oids ./random ./rsa ./util ./jsustoolkitErrCode".split(" "),p=null;"function"!==typeof define&&("object"===typeof module&&module.exports?p=function(g,h){h(require,module)}:(crosscert=window.crosscert=window.crosscert||{},r(crosscert)));(p||"function"===typeof define)&&(p||define)(["require","module"].concat(s),function(g,h){h.exports=function(c){var a=s.map(function(a){return g(a)}).concat(r);c=c||{};c.defined=c.defined||{};if(c.defined.pkcs8)return c.pkcs8;c.defined.pkcs8=!0;for(var h=0;h<a.length;++h)a[h](c);return c.pkcs8}})})();